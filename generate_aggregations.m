function Tout = generate_aggregations( T )


%% ELIMINATE: Tweak	NTstrongNTweak	dT	dNT	dTS_NTW	dNTS_TW axo	axoacc


% for responses and accuracies, we want to average responses over:
% (repetitions, taller bars, and swaps)
% result has 2016 rows (36 subjects x 28 unique color pairs x 2 targets)
Tagg_resp = varfun(@mean, T,...
    'InputVariables',{'accuracy','newresp'},...
    'GroupingVariables',{'subjnum','targetobj','ColCond',...
    'TC1','TC2','NTC1','NTC2',...
    'Tcorrect','dE','dS'});

% compute the SEM of the resps, looking across subjects.

Tagg_resp_subjMean = varfun(@mean, Tagg_resp,...
    'InputVariables',{'mean_accuracy'},...
    'GroupingVariables',{'subjnum'});

Tagg_resp = join( Tagg_resp, Tagg_resp_subjMean(:,{'subjnum','mean_mean_accuracy'}) );

Tagg_resp_grandMean = mean(Tagg_resp_subjMean.mean_mean_accuracy);

Tagg_resp.adjAccs = Tagg_resp.mean_accuracy - Tagg_resp.mean_mean_accuracy + Tagg_resp_grandMean;

n = length(unique(Tagg_resp.subjnum));
sem = @(x) std(x)/sqrt(n);

Tagg_resp_SEM = varfun(sem, Tagg_resp,...
    'InputVariables',{'adjAccs'},...
    'GroupingVariables',{'targetobj','ColCond',...
    'TC1','TC2','NTC1','NTC2',...
    'Tcorrect','dE','dS'});

Tagg_resp_SEM.Properties.VariableNames{end} = 'SEM_adjAccs';

% then, we take the MEAN over subjects
% result has 56 rows (28 unique color pairs x 2 target objects)
Tagg_resp = varfun(@mean, Tagg_resp,...
    'InputVariables',{'mean_accuracy','mean_newresp'},...
    'GroupingVariables',{'targetobj','ColCond',...
    'TC1','TC2','NTC1','NTC2',...
    'Tcorrect','dE','dS'});

%% RESPONSE TIMES
% for response time, we want to first take the MEDIAN over:
% (repetitions, taller bars, and swaps)
% result has 2016 rows (36 subjects x 28 unique color pairs x 2 targets)
Tagg_rt = varfun(@median, T,...
    'InputVariables',{'resptime'},...
    'GroupingVariables',{'subjnum','targetobj','ColCond',...
    'TC1','TC2','NTC1','NTC2',...
    'Tcorrect','dE','dS'});

% compute the SEM of the RTs, looking across subjects.

Tagg_rt_subjMean = varfun(@mean, Tagg_rt,...
    'InputVariables',{'median_resptime'},...
    'GroupingVariables',{'subjnum'});

Tagg_rt = join( Tagg_rt, Tagg_rt_subjMean(:,{'subjnum','mean_median_resptime'}) );

Tagg_rt_grandMean = mean(Tagg_rt_subjMean.mean_median_resptime);

Tagg_rt.adjRTs = Tagg_rt.median_resptime - Tagg_rt.mean_median_resptime + Tagg_rt_grandMean;

Tagg_rt_SEM = varfun(sem, Tagg_rt,...
    'InputVariables',{'adjRTs'},...
    'GroupingVariables',{'targetobj','ColCond',...
    'TC1','TC2','NTC1','NTC2',...
    'Tcorrect','dE','dS'});

Tagg_rt_SEM.Properties.VariableNames{end} = 'SEM_adjRTs';

% then, we want to take the MEAN over subjects
% result has 56 rows (28 unique color pairs x 2 target objects)
Tagg_rt = varfun(@mean, Tagg_rt,...
    'InputVariables',{'median_resptime'},...
    'GroupingVariables',{'targetobj','ColCond',...
    'TC1','TC2','NTC1','NTC2',...
    'Tcorrect','dE','dS'});


% combine everything into one table
Tout = [ Tagg_resp Tagg_resp_SEM(:,'SEM_adjAccs') Tagg_rt(:,'mean_median_resptime') Tagg_rt_SEM(:,'SEM_adjRTs')];
Tout.Properties.VariableNames(end-4:end) = {'accuracy','newresp', 'accuracySEM','resptime','resptimeSEM'};

end